name: ğŸ§ª Tests and Validation

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  GO_VERSION: '1.21'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¹ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: â¬‡ï¸ Download dependencies
      run: go mod download

    - name: ğŸ” Verify dependencies
      run: go mod verify

    - name: ğŸ§¹ Run go fmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Code is not formatted properly"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… Code is formatted correctly"

    - name: ğŸ”¬ Run go vet
      run: go vet ./...

    - name: ğŸ“š Generate and validate API documentation
      run: |
        echo "ğŸ“š Installing swag for documentation generation..."
        go install github.com/swaggo/swag/cmd/swag@latest
        
        echo "ğŸ“š Generating API documentation..."
        swag init --generalInfo internal/api/docs.go --output docs/ --parseInternal
        
        echo "ğŸ“š Validating generated documentation..."
        if [ ! -f "docs/docs.go" ]; then
          echo "âŒ docs.go not generated"
          exit 1
        fi
        
        if [ ! -f "docs/swagger.json" ]; then
          echo "âŒ swagger.json not generated"
          exit 1
        fi
        
        if [ ! -f "docs/swagger.yaml" ]; then
          echo "âŒ swagger.yaml not generated"
          exit 1
        fi
        
        echo "âœ… API documentation generated and validated successfully"

    - name: ğŸ§ª Run tests
      run: go test -v ./...

    - name: ğŸ” Basic code checks
      run: |
        echo "ğŸ” Running basic code quality checks..."
        
        # Check for goimports
        if ! command -v goimports &> /dev/null; then
          go install golang.org/x/tools/cmd/goimports@latest
        fi
        
        # Check imports
        if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Import formatting issues found:"
          goimports -l .
          echo "Run: goimports -w ."
          exit 1
        fi
        echo "âœ… Import formatting is correct"
        
        # Check for inefficient assignments
        if ! command -v ineffassign &> /dev/null; then
          go install github.com/gordonklaus/ineffassign@latest
        fi
        ineffassign ./...
        
        echo "âœ… Basic code checks passed"

    - name: ğŸ”’ Security scan with gosec
      run: |
        if ! command -v gosec &> /dev/null; then
          go install github.com/securego/gosec/v2/cmd/gosec@latest
        fi
        gosec -no-fail -fmt sarif -out results.sarif ./...

    - name: ğŸ“Š Upload SARIF file
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif

    - name: ğŸ—ï¸ Test build
      run: |
        echo "ğŸ—ï¸ Testing build process..."
        go build -o test_binary ./cmd/duckchat/main.go
        
        if [ -f "test_binary" ]; then
          chmod +x test_binary
          echo "âœ… Build successful - binary created"
          rm test_binary
        else
          echo "âŒ Build failed - no binary created"
          exit 1
        fi

    - name: ğŸ¯ Cross-compilation test
      run: |
        echo "ğŸ¯ Testing cross-compilation..."
        
        # Test Linux build
        GOOS=linux GOARCH=amd64 go build -o test_linux ./cmd/duckchat/main.go
        if [ -f "test_linux" ]; then
          echo "âœ… Linux AMD64 build successful"
          rm test_linux
        else
          echo "âŒ Linux AMD64 build failed"
          exit 1
        fi
        
        # Test Windows build
        GOOS=windows GOARCH=amd64 go build -o test_windows.exe ./cmd/duckchat/main.go
        if [ -f "test_windows.exe" ]; then
          echo "âœ… Windows AMD64 build successful"
          rm test_windows.exe
        else
          echo "âŒ Windows AMD64 build failed"
          exit 1
        fi
        
        # Test macOS build
        GOOS=darwin GOARCH=arm64 go build -o test_darwin ./cmd/duckchat/main.go
        if [ -f "test_darwin" ]; then
          echo "âœ… Darwin ARM64 build successful"
          rm test_darwin
        else
          echo "âŒ Darwin ARM64 build failed"
          exit 1
        fi
        
        echo "ğŸ‰ All cross-compilation tests passed!"
