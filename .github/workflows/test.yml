name: ğŸ§ª Tests and Validation

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

env:
  GO_VERSION: '1.21'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¹ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: â¬‡ï¸ Download dependencies
      run: go mod download

    - name: ğŸ” Verify dependencies
      run: go mod verify

    - name: ğŸ§¹ Run go fmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Code is not formatted properly"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… Code is formatted correctly"

    - name: ğŸ”¬ Run go vet
      run: go vet ./...

    - name: ğŸ§ª Run tests
      run: go test -v ./...

    - name: ğŸ—ï¸ Build test
      run: |
        echo "ğŸ—ï¸ Testing build process..."
        go build -o test_binary ./cmd/duckchat/main.go
        
        # Test that the binary was created and is executable
        if [ -f "test_binary" ]; then
          chmod +x test_binary
          echo "âœ… Build successful - binary created"
          rm test_binary
        else
          echo "âŒ Build failed - no binary created"
          exit 1
        fi

    - name: ğŸ¯ Cross-compilation test
      run: |
        echo "ğŸ¯ Testing cross-compilation..."
        
        # Test Linux build
        GOOS=linux GOARCH=amd64 go build -o test_linux ./cmd/duckchat/main.go
        if [ -f "test_linux" ]; then
          echo "âœ… Linux AMD64 build successful"
          rm test_linux
        else
          echo "âŒ Linux AMD64 build failed"
          exit 1
        fi
        
        # Test Windows build
        GOOS=windows GOARCH=amd64 go build -o test_windows.exe ./cmd/duckchat/main.go
        if [ -f "test_windows.exe" ]; then
          echo "âœ… Windows AMD64 build successful"
          rm test_windows.exe
        else
          echo "âŒ Windows AMD64 build failed"
          exit 1
        fi
        
        # Test macOS build
        GOOS=darwin GOARCH=arm64 go build -o test_darwin ./cmd/duckchat/main.go
        if [ -f "test_darwin" ]; then
          echo "âœ… Darwin ARM64 build successful"
          rm test_darwin
        else
          echo "âŒ Darwin ARM64 build failed"
          exit 1
        fi
        
        echo "ğŸ‰ All cross-compilation tests passed!"

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¹ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-lint-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-lint-

    - name: ğŸ” Run golangci-lint
      uses: golangci/golangci-lint-action@v8
      with:
        version: latest
        args: --timeout=5m

  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¹ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-security-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-security-

    - name: ğŸ”’ Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        args: '-no-fail -fmt sarif -out results.sarif ./...'

    - name: ğŸ“Š Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
